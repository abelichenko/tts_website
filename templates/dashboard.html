{% extends "base.html" %}

{% block title %}–ü–∞–Ω–µ–ª—å - TTS Website{% endblock %}

{% block content %}
<div class="dashboard">
    <h1>üé§ –ü–∞–Ω–µ–ª—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏</h1>

    <div class="user-info">
        <p>üë§ <strong>{{ current_user.email }}</strong></p>
        <p>üí∞ –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤: <strong class="token-count">{{ current_user.tokens }}</strong></p>
        <p class="hint">1 —Ç–æ–∫–µ–Ω = 10 —Å–∏–º–≤–æ–ª–æ–≤ —Ç–µ–∫—Å—Ç–∞</p>
    </div>

    <div class="tts-form">
        <h2>–°–æ–∑–¥–∞—Ç—å –æ–∑–≤—É—á–∫—É</h2>

        <form method="POST" action="">
            {{ form.hidden_tag() }}

            <div class="form-group">
                {{ form.text.label }}
                {{ form.text(class="form-control", rows="8", placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏...") }}
                {% if form.text.errors %}
                    <div class="error">{{ form.text.errors[0] }}</div>
                {% endif %}
                <div class="char-counter">
                    –°–∏–º–≤–æ–ª–æ–≤: <span id="charCount">0</span> / 5000
                    (–ü–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–∫–µ–Ω–æ–≤: <span id="tokensNeeded">0</span>)
                </div>
            </div>

            <div class="form-group">
                {{ form.voice.label }}
                {{ form.voice(class="form-control") }}
            </div>

            <button type="submit" class="btn btn-primary btn-large">
                üéµ –°–æ–∑–¥–∞—Ç—å –∞—É–¥–∏–æ
            </button>
        </form>
    </div>

    {% if conversions %}
    <div class="history">
        <h2>üìú –ò—Å—Ç–æ—Ä–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–π</h2>
        <table class="history-table">
            <thead>
                <tr>
                    <th>–î–∞—Ç–∞</th>
                    <th>–°–∏–º–≤–æ–ª–æ–≤</th>
                    <th>–¢–æ–∫–µ–Ω–æ–≤</th>
                    <th>–ì–æ–ª–æ—Å</th>
                </tr>
            </thead>
            <tbody>
                {% for conv in conversions %}
                <tr>
                    <td>{{ conv.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                    <td>{{ conv.text_length }}</td>
                    <td>{{ conv.tokens_used }}</td>
                    <td>{{ conv.voice_used.split('-')[2] if '-' in conv.voice_used else conv.voice_used }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<script>
    // –ü–æ–¥—Å—á–µ—Ç —Å–∏–º–≤–æ–ª–æ–≤ –∏ —Ç–æ–∫–µ–Ω–æ–≤
    const textarea = document.querySelector('textarea[name="text"]');
    const charCount = document.getElementById('charCount');
    const tokensNeeded = document.getElementById('tokensNeeded');

    textarea.addEventListener('input', function() {
        const length = this.value.length;
        charCount.textContent = length;
        tokensNeeded.textContent = Math.ceil(length / 10);
    });
</script>
{% endblock %}